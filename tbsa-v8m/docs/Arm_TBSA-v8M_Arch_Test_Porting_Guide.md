
# Porting Guide - TBSA-v8M Architecture test suite 
-----------------------------------------------------

## Introduction
The TBSA-v8M Architecture test suite contains a platform abstraction layer (PAL) which abstracts platform specific information from the tests.
 - The PAL layer interface functions need to implemented/ported to the target platform.
 - The target config file must be created/updated to match the details of the target platform.

This document provides details on the porting steps and the PAL APIs.

## Porting steps

### Target configuration

  You must populate your system configuration and provide it as an input to test suite.

This is captured in a single static input configuration file that is named as tbsa_tgt.cfg. This file is available at syscomp_tbsa_m/platform/board/<target>. <br />

An example of the input configuration file is as shown.

	//PERIPHERALS
	timer.num = 2;
	timer.0.vendor_id = 0x0;
	timer.0.device_id = 0x0;
	timer.0.base = 0x50000000;
	timer.0.intr_id = 0x8;
	timer.0.attribute = SECURE_PROGRAMMABLE;
	//MEMORY
	sram.num = 2;
	sram.1.start = 0x30000000;
	sram.1.end = 0x303FFFFF;
	sram.1.attribute = MEM_SECURE;
	sram.1.mem_type = TYPE_NORMAL_READ_WRITE;
	sram.1.dpm_index = 0;

  More details on the structure of the input can be obtained from val/include/val_target.h.


### Create a new target

  Since TBSA-v8M test suite is agnostic to various system targets, before building the tests, you must port the files mentioned in the following steps.

**Procedure**
----------------
  - Create a new directory in platform/board/<platform_name>. For reference, see the existing platform fvp.
  - The peripheral code exists inside platform/peripherals/<peripheral_name>. If <platform_name> is using the peripherals that already exist in platform/peripherals/<peripheral_name>,
    then this code can be reused. Otherwise, the code must be ported for platformspecific peripherals.
  - Update platform/board/<platform_name>/Makefile with the appropriate path of the peripherals used.
  - Update platform/board/<platform_name>/src/pal_baremetal_intf.c with the correct instance of the peripherals used.
  - Update the primary input for the TBSA-v8M tests, that is, target configuration file in platform/board/<platform_name>/tbsa_tgt.cfg. Use platform/boards/fvp/tbsa_tgt.cfg as reference.
  - Refer val/include/val_target.h for structure details.

**Note**:
  pal_nvram_read and pal_nvram_write of the reference FVP platform code simulate non-volatility of the data across resets by ensuring that the memory range is not initialized across warm boots.
  A partner board may choose to simulate the same or provide NVRAM using external storage or Internal Flash.

## PAL API list
  These functions will require implementation/porting to the target platform. <br />
  
**Note**:  
The NVIC functions are CMSIS compliant. The CMSIS repository on Github is cloned during build. A partner need not port the NVIC functions if there are no platform specific changes.

|   	|                                             	|                                                                                                                                                                   	|                                                                                                    	|                                                                                                                                                                                                                                                                            	|   	|   	|
|---	|---------------------------------------------	|-------------------------------------------------------------------------------------------------------------------------------------------------------------------	|----------------------------------------------------------------------------------------------------	|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------	|---	|---	|
|   	| Function name                               	| Prototype                                                                                                                                                         	| Description                                                                                        	| Parameters                                                                                                                                                                                                                                                                 	|   	|   	|
|   	| pal_NVIC_EnableIRQ                          	| void pal_NVIC_EnableIRQ(uint32_t intr_num);                                                                                                                       	| Enables interrupt.                                                                                 	| intr_num: interrupt number.                                                                                                                                                                                                                                                	|   	|   	|
|   	| pal_NVIC_DisableIRQ                         	| void pal_NVIC_DisableIRQ(uint32_t intr_num);                                                                                                                      	| Disables interrupt.                                                                                	| intr_num: interrupt number.                                                                                                                                                                                                                                                	|   	|   	|
|   	| pal_NVIC_ClearTargetState                   	| uint32_t pal_NVIC_ClearTargetState(uint3 2_t intr_num);                                                                                                           	| Clears interrupt target state.                                                                     	| intr_num: interrupt number.                                                                                                                                                                                                                                                	|   	|   	|
|   	| pal_NVIC_SetTargetState                     	| uint32_t pal_NVIC_SetTargetState(uint32_ t intr_num);                                                                                                             	| Sets interrupt target state.                                                                       	| intr_num: interrupt number.                                                                                                                                                                                                                                                	|   	|   	|
|   	| pal_NVIC_SetPriority                        	| void pal_NVIC_SetPriority(uint32_t intr_num, uint32_t priority);                                                                                                  	| Sets interrupt priority.                                                                           	| intr_num: interrupt number;  priority: priority to set.                                                                                                                                                                                                                    	|   	|   	|
|   	| pal_NVIC_GetPriority                        	| uint32_t pal_NVIC_GetPriority(uint32_t intr_num);                                                                                                                 	| Gets interrupt priority.                                                                           	| intr_num: interrupt number. It returns the interrupt   priority.                                                                                                                                                                                                           	|   	|   	|
|   	| pal_NVIC_SetPendingIRQ                      	| void pal_NVIC_SetPendingIRQ(uint32_t intr_num);                                                                                                                   	| Sets pending interrupt.                                                                            	| intr_num: interrupt number.                                                                                                                                                                                                                                                	|   	|   	|
|   	| pal_NVIC_GetPendingIRQ                      	| uint32_t pal_NVIC_GetPendingIRQ(uint32_t intr_num);                                                                                                               	| Clears the pending interrupt.                                                                      	| intr_num: interrupt number.                                                                                                                                                                                                                                                	|   	|   	|
|   	| pal_NVIC_ClearPendingIRQ                    	| void pal_NVIC_ClearPendingIRQ(uint32_t intr_num);                                                                                                                 	| Gets pending interrupt.                                                                            	| intr_num: interrupt number.                                                                                                                                                                                                                                                	|   	|   	|
|   	| pal_NVIC_GetActive                          	| uint32_t pal_NVIC_GetActive(uint32_t intr_num);                                                                                                                   	| Gets active interrupts.                                                                            	| intr_num: interrupt number.                                                                                                                                                                                                                                                	|   	|   	|
|   	| pal_i2c_init                                	| void pal_i2c_init(void);                                                                                                                                          	| Initializes the I2C peripheral.                                                                    	|                                                                                                                                                                                                                                                                            	|   	|   	|
|   	| pal_i2c_read                                	| int pal_i2c_read(uint32_t slv_addr, uint8_t *rd_data, uint32_t len);                                                                                              	| Reads peripherals using I2C. slv_addr: address of the peripheral. rd_data: read buffer.            	| len: length of the read buffer in bytes.                                                                                                                                                                                                                                   	|   	|   	|
|   	| pal_i2c_write                               	| int pal_i2c_write(uint32_t slv_addr, uint8_t *wr_data, uint32_t len);                                                                                             	| Writes peripherals using I2C. slv_addr: address of the peripheral. wr_data: write buffer.          	| len: length of the write buffer in bytes.                                                                                                                                                                                                                                  	|   	|   	|
|   	| pal_spi_init                                	| void pal_spi_init(void);                                                                                                                                          	| Initializes the SPI peripheral.                                                                    	|                                                                                                                                                                                                                                                                            	|   	|   	|
|   	| pal_spi_read                                	| int pal_spi_read(uint32_t addr, uint8_t *data, uint32_t len);                                                                                                     	| Reads peripherals using SPI commands.                                                              	| addr: address of the peripheral; data: read buffer;   len: length of the read buffer in bytes.                                                                                                                                                                             	|   	|   	|
|   	| pal_spi_write                               	| int pal_spi_write(uint32_t addr, uint8_t *data, uint32_t len);                                                                                                    	| Writes peripherals using SPI commands.                                                             	| addr: address of the peripheral; data: write buffer;   len: length of the write buffer in bytes.                                                                                                                                                                           	|   	|   	|
|   	| pal_crypto_init                             	| void pal_crypto_init(addr_t crypto_base_addr);                                                                                                                    	| Initializes the cryptographic functions.                                                           	| crypto_base_addr: base address of the crypto module.                                                                                                                                                                                                                                                                           	|   	|   	|
|   	| pal_timer_init                              	| int pal_timer_init (addr_t base_addr, uint32_t time_us, uint32_t   timer_tick_us);                                                                                	| Initializes a hardware timer.                                                                      	| base_addr: base address of the timer module; time_us: time in micro   seconds. timer_tick_us: number of ticks per micro second.                                                                                                                                            	|   	|   	|
|   	| pal_timer_enable                            	| int pal_timer_enable (addr_t base_addr);                                                                                                                          	| Enables a hardware timer.                                                                          	| base_addr: base address of the timer module.                                                                                                                                                                                                                               	|   	|   	|
|   	| pal_timer_disable                           	| int pal_timer_disable (addr_t base_addr);                                                                                                                         	| Disables a hardware timer.                                                                         	| base_addr: base address of the timer module.                                                                                                                                                                                                                               	|   	|   	|
|   	| pal_timer_interrupt_clear                   	| int pal_timer_interrupt_clear (addr_t base_addr);                                                                                                                 	| Clears the interrupt status of the timer.                                                          	| base_addr: base address of the timer module.                                                                                                                                                                                                                               	|   	|   	|
|   	| pal_wd_timer_init                           	| int pal_wd_timer_init (addr_t base_addr, uint32_t time_us, uint32_t   timer_tick_us);                                                                             	| Initializes a hardware watchdog timer.                                                             	| base_addr: base address of the watchdog module;   time_us: time in micro seconds; timer_tick_us: number of ticks per micro   second.                                                                                                                                       	|   	|   	|
|   	| pal_wd_timer_enable                         	| int pal_wd_timer_enable (addr_t base_addr);                                                                                                                       	| Enables a hardware watchdog timer.                                                                 	| base_addr: base address of the watchdog module.                                                                                                                                                                                                                            	|   	|   	|
|   	| pal_is_wd_timer_enabled                     	| int pal_is_wd_timer_enabled (addr_t base_addr);                                                                                                                   	| Disables a hardware watchdog timer.                                                                	| base_addr: base address of the watchdog module.                                                                                                                                                                                                                            	|   	|   	|
|   	| pal_wd_timer_disable                        	| int pal_wd_timer_disable (addr_t base_addr);                                                                                                                      	| Checks whether hardware watchdog is enabled.                                                       	| base_addr: base address of the watchdog module.                                                                                                                                                                                                                            	|   	|   	|
|   	| pal_crypto_aes_generate_key                 	| int pal_crypto_aes_generate_key(uin t8_t *key, uint32_t size);                                                                                                    	| Generates AES key using various specified entropy sources.                                         	| key : the buffer where the generated key is stored;   size : size of the key to be generated. Valid options are 128 bits, 192 bits,   or 256 bits                                                                                                                          	|   	|   	|
|   	| pal_crypto_compute_hash                     	| int pal_crypto_compute_hash(unsigne d char *input, size_t ilen, unsigned   char *output, int algo);                                                               	| Calculates the SHA-224 or SHA-256 checksum of a buffer.                                            	| input : the buffer holding the data; ilen : the   length of the input data; output : the SHA-224 or SHA-256 checksum result;   algo : determines which function to use. (0: Use SHA-256, 1: Use SHA-224);                                                                  	|   	|   	|
|   	| pal_uart_init                               	| void pal_uart_init (addr_t uart_base_addr);                                                                                                                       	| Initializes the UART.                                                                              	| uart_base_addr : base address of the UART                                                                                                                                                                                                                                  	|   	|   	|
|   	| pal_uart_tx                                 	| void pal_uart_tx (uint8_t data);                                                                                                                                  	| Sends data to UART TX FIFO.                                                                        	| data : data to be written to TX FIFO.                                                                                                                                                                                                                                      	|   	|   	|
|   	| pal_get_target_cfg_start                    	| void *pal_get_target_cfg_start(void);                                                                                                                             	| Provides the database source   location. It returns base address of database.                      	|                                                                                                                                                                                                                                                                            	|   	|   	|
|   	| pal_nvram_write                             	| int pal_nvram_write(addr_t base, uint32_t offset, void *buffer, int   size);                                                                                      	| Writes 'size' bytes from buffer into NVRAM at a given 'base + offset'.                             	| base : base address of NVRAM; offset : offset; buffer   : pointer to source address; size : number of bytes. It returns the error   status.                                                                                                                                	|   	|   	|
|   	| pal_nvram_read                              	| int pal_nvram_read (addr_t base, uint32_t offset, void *buffer, int   size);                                                                                      	| Reads 'size' bytes from NVRAM at a given 'base + offset' into given   buffer.                      	| base : base address of NVRAM; offset : offset; buffer   : pointer to source address; size : number of bytes                                                                                                                                                                	|   	|   	|
|   	| pal_system_warm_reset                       	| void pal_system_warm_reset(void);                                                                                                                                 	| Generates system Warm reset.                                                                       	|                                                                                                                                                                                                                                                                            	|   	|   	|
|   	| pal_system_cold_reset                       	| void pal_system_cold_reset(void);                                                                                                                                 	| Generates system Cold reset.                                                                       	|                                                                                                                                                                                                                                                                            	|   	|   	|
|   	| pal_is_cold_reset                           	| int pal_is_cold_reset(void);                                                                                                                                      	| Reports the last reset type.                                                                       	|                                                                                                                                                                                                                                                                            	|   	|   	|
|   	| pal_is_warm_reset                           	| int pal_is_warm_reset(void);                                                                                                                                      	| Reports the last reset type.                                                                       	|                                                                                                                                                                                                                                                                            	|   	|   	|
|   	| pal_dpm_set_access_ns_only                  	| int pal_dpm_set_access_ns_only(uint 32_t index, bool_t access_ns);                                                                                                	| Sets the debug permission based on the input argument.                                             	| index : DPM index; access_ns : TRUE - allow debug   access only for Non-secure address, FALSE - allow debug access to both Secure   and Non-secure addresses;                                                                                                              	|   	|   	|
|   	| pal_mpc_configure_mem_to_nonsec ure         	| int pal_mpc_configure_mem_to_nonsec ure (addr_t start_addr,addr_t   end_addr);                                                                                    	| Allows a memory region to be configured as Non-secure via MPC.                                     	| instance : MPC instance number;  addr : memory address to be configured by   MPC; sec_attr : map the address to either Secure or Non-secure security   attribute.                                                                                                          	|   	|   	|
|   	| pal_mpc_configure_mem_to_secure             	| int pal_mpc_configure_mem_to_secure (addr_t start_addr,addr_t end_addr);                                                                                          	| Allows a memory region to be configured as Secure via MPC.                                         	| instance : MPC instance number;     addr : memory address to be configured by MPC;      sec_attr : map the address to either Secure or Non-secure security   attribute.                                                                                                    	|   	|   	|
|   	| pal_fuse_read                               	| int pal_fuse_read(addr_t addr, uint32_t *data, size_t size);                                                                                                      	| Read the value of given fuse address.                                                              	| addr : address of the fuse;      data : buffer to store the data;     size : number of words to be read.                                                                                                                                                                   	|   	|   	|
|   	| pal_fuse_write                              	| int pal_fuse_write(addr_t addr, uint32_t *data, size_t size);                                                                                                     	| Writes the value in given fuse address.                                                            	| addr : address of the fuse.     data : data to be written;     size : number of words to be read.                                                                                                                                                                                                                 	|   	|   	|
|   	| pal_fuse_count_zeros_in_rotpk               	| int pal_fuse_count_zeros_in_rotpk(u int32_t *zero_cnt);                                                                                                           	| Counts the number of zeros in ROTPK.                                                               	| zero_cnt : buffer to store the zero count.                                                                                                                                                                                                                                 	|   	|   	|
|   	| pal_fuse_count_zeros                        	| void pal_fuse_count_zeros(uint32_t value, uint32_t *zero_cnt);                                                                                                    	| Counts the number of zeros in the given value.                                                     	| value : number of zeros to be determined; zero_cnt :   buffer to store the zero count.                                                                                                                                                                                     	|   	|   	|
|   	| pal_fuse_get_lcs                            	| int pal_fuse_get_lcs(uint32_t *pLcs);                                                                                                                             	| Reads the LCS register.                                                                            	| pLcs : buffer to store the LCS value                                                                                                                                                                                                                                                                           	|   	|   	|
|   	| pal_crypto_validate_certificate             	| int pal_crypto_validate_certificat e(uint32_t certificate_base_addr,   uint32_t public_key_addr, uint32_t certificate_size, uint32_t   public_key_size);          	| Validates the certificate using public key.                                                        	| certificate_base_addr : base address of the certificate where it is   stored in memory;      public_key_addr : base address of the public key where it is stored in   memory;     certificate_size : certificate memory size;     public_key_size : public key memory size 	|   	|   	|
|   	| pal_crypto_get_uniqueID_from_ce   rtificate 	| int pal_crypto_get_uniqueID_from_ce rtificate(uint32_t   certificate_base_addr, uint32_t public_key_addr, uint32_t certificate_size,   uint32_t public_key_size); 	| Gets unique ID from valid certificate using public key.                                            	| certificate_base_addr : base address of the   certificate where it is stored in memory.     public_key_addr : base address of the public key where it is stored in   memory.     certificate_size : certificate memory size.     public_key_size : public key memory size  	|   	|   	|
|   	| pal_rtc_init                                	| int pal_rtc_init(addr_t base_addr);                                                                                                                               	| Initializes RTC.                                                                                   	| base_addr: base address of the given RTC instance.                                                                                                                                                                                                                         	|   	|   	|
|   	| pal_is_rtc_trustable                        	| int pal_is_rtc_trustable(addr_t base_addr);                                                                                                                       	| RTC validity mechanism to indicate whether RTC is Trusted or Non-trusted.                          	| base_addr: base address of the given RTC instance.                                                                                                                                                                                                                         	|   	|   	|
|   	| pal_is_rtc_synced_to_server                 	| int pal_is_rtc_synced_to_server(add r_t base_addr);                                                                                                               	| RTC validity mechanism to indicate RTC is synced with server or not.                               	| base_addr: base address of the given RTC instance.                                                                                                                                                                                                                         	|   	|   	|
|   	| pal_crypto_get_dpm_from_key                 	| int pal_crypto_get_dpm_from_key(uin t32_t public_key_addr, uint32_t   public_key_size, uint32_t *dpm_field);                                                      	| Gets DPM field from public key.                                                                    	| public_key_addr : base address of the public key   where it is stored in memory.     public_key_size : public key memory size.     dpm_field : buffer to store DPM number.                                                                                                 	|   	|   	|
|   	| pal_crypto_get_dpm_from_certifi cate        	| int pal_crypto_get_dpm_from_certifi cate(uint32_t certificate_base_addr,   uint32_t certificate_size, uint32_t *dpm_field);                                       	| Gets DPM field from certificate.                                                                   	| certificate_base_addr : base address of the   certificate where it is stored in memory.     certificate_size : certificate memory size.     dpm_field : buffer to store DPM number.                                                                                        	|   	|   	|
|   	| pal_firmware_version_update                 	| int pal_firmware_version_update(uin t32_t instance,   firmware_version_type_t firmware_version_type, uint32_t fw_ver_cnt);                                        	| Updates the firmware version.                                                                      	| instance : instance if the firmware     fw_ver_cnt : version of the firmware.                                                                                                                                                                                              	|   	|   	|
|   	| pal_firmware_version_read                   	| int pal_firmware_version_read(uint3 2_t instance, firmware_version_type_t   firmware_version_type);                                                               	| Reads the firmware version..                                                                       	|  instance : instance if the   firmware                                                                                                                                                                                                                                     	|   	|   	|
|   	|                                             	|                                                                                                                                                                   	|                                                                                                    	|                                                                                                                                                                                                                                                                            	|   	|   	|
|   	|                                             	|                                                                                                                                                                   	|                                                                                                    	|                                                                                                                                                                                                                                                                            	|   	|   	|


## License
Arm TBSA-v8M Architecture test suite is distributed under Apache v2.0 License.

--------------

*Copyright (c) 2018, Arm Limited and Contributors. All rights reserved.*
